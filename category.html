<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TailsUp | Tienda</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/nav.css">
    <link rel="stylesheet" href="css/footer.css">
    <link rel="stylesheet" href="css/ProductosSection.css">
    <link rel="stylesheet" href="css/category/mystylecategory.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
    <header>
        <nav>
            <div class="medio">
                <img class="logoNav" src="images/logoCompleto.png" alt="logoNav.png">
                <div class="buscadorDiv">
                    <button id="btnBuscar"><img src="images/lupa.png" alt="lupa.png"></button>
                    <input class="buscador" type="search" placeholder="Buscar" id="inputBusqueda">
                    <div id="resultadosBusqueda" class="resultadosBusqueda"></div>
                </div>

                <div class="accesoDirecto">
                    <div class="navDiv">
                        <a class="carritoBtn" href="carrito.html"><img class="carrito" src="images/Carrito.png"
                                alt="carrito.png"></a>
                        <a class="carritoTxt" href="carrito.html">Carrito</a>
                    </div>
                    <div class="navDiv">
                        <a id="micuentaImg" class="loginBtn" href="login.html"><img class="login"
                                src="images/micuenta.png" alt="micuenta.png"></a>
                        <a id="micuenta" class="miCuentaTxt" id="micuenta" href="login.html">Mi cuenta</a>
                    </div>
                </div>

            </div>
            <div class="abajo">
                <a href="index.html">Home</a>
                <a href="shop.html">Tienda</a>
                <a href="hola">Consejos</a>
                <a href="hola">Acerca de</a>

                <div id="menuUsuario" class="dropdown-menu">
                    <div class="cart-tab"></div>
                    <ul>
                        <li><a href="favoritos.html">Favoritos</a></li>
                        <li><a href="#" id="cerrarSesion">Cerrar sesión</a></li>
                    </ul>
                </div>
            </div>

        </nav>
    </header>
     <div class="containerShopByPet">
        <h1>Comprar por mascota</h1>
        <div class="containerBtnCategoria">
            <button class="btnCategoriaPet" data-categoria="Gato"><img src="images/imgBtnCat.png" alt="btnCat.png">
                Gato</button>
            <button class="btnCategoriaPet" data-categoria="Hamster"><img src="images/imgBtnHamster.png"
                    alt="btnCat.png">Hamster</button>
            <button class="btnCategoriaPet" data-categoria="Perro"><img src="images/imgBtnDog.png"
                    alt="btnCat.png">Perro</button>
            <button class="btnCategoriaPet" data-categoria="Ave"><img src="images/imgBtnAve.png"
                    alt="btnCat.png">Ave</button>
            <button class="btnCategoriaPet" data-categoria="Conejo"><img src="images/imgBtnConejo.png"
                    alt="btnCat.png">Conejo</button>
            <button class="btnCategoriaPet" data-categoria="Tortuga"><img src="images/imgBtnTortuga.png"
                    alt="btnCat.png">Tortuga</button>
        </div>
    </div>
    <div class="divBtnFiltros">
        <button class="toggleFiltrosBtn">☰ Filtros</button>
    </div>
    <div class="containerFiltro-Products">
        <div class="containerFiltros">
            <button class="cerrarBtn">X</button>
            <h4 class="titlePrecio">Filtrar por precio</h4>
            <input type="range" class="rangoPrecio" min="9" max="399">
            <div class="containerTextFiltro">
                <p>Price: $9 - $399</p><button class="btnAplicar">Aplicar</button>
            </div>
            <h4 class="titleBrands">Filter by brands</h4>
            <div class="containerInputs">
                <div>
                    <label class="filter-option"><input type="checkbox" value="Natural food">
                        Natural food </label>
                    <label class="filter-option"><input type="checkbox" value="Pet care"> Pet care
                    </label>
                    <label class="filter-option"><input type="checkbox" value="Dogs friend"> Dogs
                        friend </label>
                    <label class="filter-option"><input type="checkbox" value="Pet food"> Pet food
                    </label>
                    <label class="filter-option"><input type="checkbox" value="Favorite pet">
                        Favorite pet </label>
                    <label class="filter-option"><input type="checkbox" value="Green line"> Green
                        line </label>
                </div>
                <div class="containerNumInputs">
                    <span>28</span>
                    <span>16</span>
                    <span>18</span>
                    <span>40</span>
                    <span>26</span>
                    <span>15</span>
                </div>
            </div>
            <h4 class="titleBrands">Filter by tags</h4>
            <div class="tags">
                <div>
                    <button class="tag filtro-tag" data-tag="Dog food">Dog food</button>
                    <button class="tag filtro-tag" data-tag="Cat food">Cat food</button>
                    <button class="tag filtro-tag" data-tag="Natural">Natural</button>
                </div>
                <div>
                    <button class="tag filtro-tag" data-tag="Parrot">Parrot</button>
                    <button class="tag filtro-tag" data-tag="Small dog">Small dog</button>
                    <button class="tag filtro-tag" data-tag="Cat">Cat</button>
                </div>
                <h4 class="titleBrands">Productos populares</h4>
                <div class="containerPopPrd">
                    <div class="PopularPrd">
                        <div class="imgProduct">
                            <img src="images/filletOFlakes.png" alt="imagenProducto">
                        </div>
                        <div class="textPopPrd">
                            <h4>Producto mamalon</h4>
                            <p>$567</p>
                        </div>
                    </div>
                    <div class="PopularPrd">
                        <div class="imgProduct">
                            <img src="images/filletOFlakes.png" alt="imagenProducto">
                        </div>
                        <div class="textPopPrd">
                            <h4>Mas producto</h4>
                            <p>$290</p>
                        </div>
                    </div>
                    <div class="PopularPrd">
                        <div class="imgProduct">
                            <img src="images/pelotita.png" alt="imagenProducto">
                        </div>
                        <div class="textPopPrd">
                            <h4>Sexoooooo</h4>
                            <p>$121</p>
                        </div>
                    </div>
                    <div class="PopularPrd">
                        <div class="imgProduct">
                            <img src="images/encore..png" alt="imagenProducto">
                        </div>
                        <div class="textPopPrd">
                            <h4>masSexo</h4>
                            <p>$234</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="contenedor">
            
        </div>
        <div id="modalProducto" class="modal-producto">
        <div class="modal-contenido-wrapper">
            <span class="cerrar-modal" onclick="cerrarModalProducto()">&times;</span>

            <!-- Sección principal con imagen e info -->
            <div class="modal-contenido-grid">
                <div class="modal-img">
                    <img id="modalImagenProducto" src="" alt="Imagen del producto">
                    <p class="ampliarTexto">Coloca el cursor sobre la imagen para hacer zoom</p>
                </div>

                <div class="modal-info">
                    <h2 id="modalNombreProducto" class="titulo"></h2>
                    <p id="modalMarcaProducto" class="marca-link"></p>

                    <div class="rating">
                        <div id="modalEstrellas" class="estrellas-dinamicas"></div>
                        <span id="modalRatingVentas"></span>
                    </div>

                    <div class="precioSeccion">
                        <p class="precio-actual" id="modalPrecioProducto"></p>
                        <p class="precio-anterior" id="modalPrecioAnteriorProducto"></p>
                    </div>

                    <p id="modalDescripcionProducto" class="descripcion"></p>

                    <div class="cantidadCompra">
                        <label for="cantidad" style="font-family: poppins;">Cantidad:</label>
                        <div class="cantidadControles">
                            <button type="button" onclick="cambiarCantidad(-1)">−</button>
                            <input type="number" id="cantidad" name="cantidad" value="1" min="1" readonly>
                            <button type="button" onclick="cambiarCantidad(1)">+</button>
                        </div>
                    </div>

                    <div class="botonesModal">
                        <button class="btnCompraModal">Comprar ahora</button>
                        <button class="btnCarritoModal">
                            <img src="images/CarritoSimple.png" alt="carrito"> Agregar al carrito
                        </button>
                    </div>
                </div>
            </div>

            <!-- Comentarios -->
            <div class="zonaComentarios">
                <h3>Reseñas</h3>
                <div id="comentariosLista" class="comentarios-lista">
                    <!-- Comentarios cargados dinámicamente -->
                </div>

                <div class="comentarioForm">
                    <label for="ratingComentario">Tu calificación:</label>
                    <div id="estrellasFormulario" class="estrellas-formulario">
                        <!-- Se llenan dinámicamente -->
                    </div>

                    <textarea id="nuevoComentario" placeholder="Escribe tu comentario..."></textarea>
                    <button onclick="agregarComentario()">Enviar</button>
                </div>
            </div>

        </div>
    </div>
        <script src="js/buscarAndFullCard.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Opción 1: si usaste localStorage
  const categoria = localStorage.getItem('categoriaSeleccionada');
  if (categoria) {
    document.querySelector('h1').textContent = `${categoria}`;    
  }
});

</script>
<script>
let productosFavoritos = [];
let productosCategoria = [];
let categoriaSeleccionada = localStorage.getItem('categoriaSeleccionada'); // comida, juguetes, etc.
let categoriaBotonSeleccionada = null; // gato, perro, etc.

const aliasCategorias = {
  comida: ['alimento'],
  juguetes: ['juguete']
};

const aliasAnimales = {
  gatos: ['gato', 'gatito'],
  perros: ['perro', 'perrito'],
  tortuga: ['tortuga'],
  conejo: ['conejo'],
  hamster: ['hamster'],
  ave: ['ave', 'pájaro', 'perico']
};

document.addEventListener('DOMContentLoaded', function () {
  if (!categoriaSeleccionada) {
    document.getElementById('contenedor').innerHTML = '<p>❌ Categoría no seleccionada</p>';
    return;
  }

  inicializar();

  document.querySelectorAll('.btnCategoriaPet').forEach(btn => {
   btn.addEventListener('click', function () {
    const categoria = this.getAttribute('data-categoria').toLowerCase();

    if (this.classList.contains('selected')) {
      this.classList.remove('selected');
      categoriaBotonSeleccionada = null;
    } else {
      document.querySelectorAll('.btnCategoriaPet').forEach(b => b.classList.remove('selected'));
      this.classList.add('selected');
      categoriaBotonSeleccionada = categoria + 's'; // 👈 ajuste aquí
    }

    aplicarFiltros();
  });
  });

  document.querySelectorAll('.filter-option input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', aplicarFiltros);
  });

  const inputRango = document.querySelector('.rangoPrecio');
  if (inputRango) {
    inputRango.addEventListener('input', () => {
      document.querySelector('.containerTextFiltro p').textContent = `Price: $9 - $${inputRango.value}`;
    });
    document.querySelector('.btnAplicar').addEventListener('click', aplicarFiltros);
  }

  document.querySelectorAll('.filtro-tag').forEach(btn => {
    btn.addEventListener('click', function () {
      this.classList.toggle('activo');
      aplicarFiltros();
    });
  });
});

function inicializar() {
  const usuario = localStorage.getItem('usuario');
  if (!usuario) {
    obtenerProductosCategoria();
  } else {
    fetch("http://localhost/TailsUp-Backend/endPointGetFavoritos.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ usuario })
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          productosFavoritos = data.productos.map(p => Number(p.id_producto));
        }
        obtenerProductosCategoria();
      })
      .catch(err => {
        console.error("❌ Error al obtener favoritos:", err);
        obtenerProductosCategoria();
      });
  }
}

function obtenerProductosCategoria() {
  fetch("http://localhost/TailsUp-Backend/endPointGetProductos.php")
    .then(res => res.json())
    .then(data => {
      const claves = aliasCategorias[categoriaSeleccionada.toLowerCase()] || [];
      productosCategoria = data.filter(p => {
        const cat = p.categoria?.toLowerCase() || '';
        return claves.some(clave => cat.includes(clave));
      });

      aplicarFiltros();
    })
    .catch(err => {
      console.error("❌ Error al obtener productos:", err);
    });
}

function aplicarFiltros() {
  const maxPrecio = Number(document.querySelector('.rangoPrecio')?.value) || 399;

  const marcasSeleccionadas = Array.from(document.querySelectorAll('.filter-option input[type=checkbox]:checked'))
    .map(cb => cb.value.toLowerCase());

  const tagsSeleccionados = Array.from(document.querySelectorAll('.filtro-tag.activo'))
    .map(btn => btn.dataset.tag.toLowerCase());

  const clavesAnimal = categoriaBotonSeleccionada
    ? aliasAnimales[categoriaBotonSeleccionada] || []
    : [];

  const productosFiltrados = productosCategoria.filter(p => {
    const nombre = p.nombre_producto?.toLowerCase() || '';
    const descripcion = p.descripcion?.toLowerCase() || '';
    const categoriaTexto = p.categoria?.toLowerCase() || '';

    const cumpleAnimal = clavesAnimal.length === 0 ||
      clavesAnimal.some(palabra =>
        nombre.includes(palabra) ||
        descripcion.includes(palabra) ||
        categoriaTexto.includes(palabra)
      );

    const cumplePrecio = Number(p.precio_actual) <= maxPrecio;
    const cumpleMarca = marcasSeleccionadas.length === 0 || marcasSeleccionadas.includes(p.marca?.toLowerCase());
    const cumpleTags = tagsSeleccionados.length === 0 ||
      tagsSeleccionados.some(tag =>
        nombre.includes(tag) || descripcion.includes(tag)
      );

    return cumpleAnimal && cumplePrecio && cumpleMarca && cumpleTags;
  });
  actualizarContadoresMarca(productosCategoria); 

  renderProductos(productosFiltrados);
}
function actualizarContadoresMarca(listaProductos) {
  const marcas = document.querySelectorAll('.filter-option input[type=checkbox]');
  const spans = document.querySelectorAll('.containerNumInputs span');

  const conteo = {}; // objeto tipo: { "natural food": 3, ... }

  listaProductos.forEach(p => {
    const marca = p.marca?.toLowerCase();
    if (!conteo[marca]) conteo[marca] = 0;
    conteo[marca]++;
  });

  marcas.forEach((input, index) => {
    const marca = input.value.toLowerCase();
    spans[index].textContent = conteo[marca] || 0;
  });
}


function renderProductos(productos) {
  const contenedor = document.getElementById('contenedor');
  contenedor.innerHTML = '';

  if (productos.length === 0) {
    contenedor.innerHTML = '<p>No se encontraron productos.</p>';
    return;
  }

  productos.forEach(p => {
    const card = document.createElement('div');
    card.className = 'productCard';

    const esFavorito = productosFavoritos.includes(Number(p.id_producto));
    const claseCorazon = esFavorito ? 'fa-solid' : 'fa-regular';
    const claseLiked = esFavorito ? 'liked' : '';

    card.innerHTML = `
      <div class="productImage">
        <button class="heart-button ${claseLiked}" onclick="toggleHeart(this, ${p.id_producto})">
          <i class="${claseCorazon} fa-heart"></i>
        </button>
        <img src="images/${p.imagen_producto}" alt="${p.nombre_producto}">
      </div>
      <div class="productTitle"><h4>${p.nombre_producto}</h4></div>
      <div class="productRating" style="font-family:poppins;">
        <img src="images/Star.png" alt="Estrella">
        <p>(${p.rating}) ${p.unidades_vendidas} Sold</p>
      </div>
      <div class="productPrice" style="font-family:poppins;">
        <p>
          $${formatearPrecio(p.precio_actual)}
          ${p.precio_anterior && p.precio_anterior !== p.precio_actual
            ? `<s>$${formatearPrecio(p.precio_anterior)}</s>` : ''}
        </p>
      </div>
      <div class="productBtns">
        <button class="btnCompra" onclick="verificarAccionUsuario(() => alert('Comprar ${p.id_producto}'))">Comprar ahora</button>
        <button class="btnCarrito" onclick="verificarAccionUsuario(() => alert('Agregar al carrito ${p.id_producto}'))">
          <img src="images/CarritoSimple.png" alt="carritoSimple.png">
        </button>
      </div>
    `;

    card.addEventListener('click', function (e) {
      if (e.target.closest('button')) return;
      mostrarDetallesProducto(p);
    });        
    contenedor.appendChild(card);
    
  });
    manejarTruncadoResponsivo('.productTitle');
  iniciarAjustes();
}
function manejarTruncadoResponsivo(selector) {
  const maxCaracteres = window.innerWidth <= 768 ? 10 : 22;
  document.querySelectorAll(selector).forEach(elemento => {
    const titulo = elemento.querySelector('h4');
    if (!titulo) return;
    if (!titulo.hasAttribute('data-texto-completo')) {
      titulo.setAttribute('data-texto-completo', titulo.textContent.trim());
    }
    const textoOriginal = titulo.getAttribute('data-texto-completo');
    titulo.textContent = textoOriginal.length > maxCaracteres
      ? textoOriginal.substring(0, maxCaracteres) + '...'
      : textoOriginal;
    titulo.setAttribute('title', textoOriginal);
  });
}

function iniciarAjustes() {
  const reglas = {
    default: '13px',
    condiciones: [
      { maxCaracteres: 10, fontSize: '16px' },
      { maxCaracteres: 14, fontSize: '14px' },
      { maxCaracteres: 18, fontSize: '12px' }
    ]
  };
  ajustarTamañoFuente('.productRating p', reglas);
  ajustarTamañoFuente('.productPrice p', reglas);
}
function ajustarTamañoFuente(selector, reglas) {
  document.querySelectorAll(selector).forEach(elemento => {
    const texto = elemento.textContent.trim();
    let fontSize = reglas.default;
    for (let regla of reglas.condiciones) {
      if (texto.length >= regla.maxCaracteres) {
        fontSize = regla.fontSize;
      }
    }
    elemento.style.fontSize = fontSize;
  });
}
function manejarTruncadoResponsivo(selector) {
    const maxCaracteres = window.innerWidth <= 768 ? 10 : 22;
    document.querySelectorAll(selector).forEach(elemento => {
      const titulo = elemento.querySelector('h4');
      if (!titulo) return;
      if (!titulo.hasAttribute('data-texto-completo')) {
        titulo.setAttribute('data-texto-completo', titulo.textContent.trim());
      }
      const textoOriginal = titulo.getAttribute('data-texto-completo');
      titulo.textContent = textoOriginal.length > maxCaracteres
        ? textoOriginal.substring(0, maxCaracteres) + '...'
        : textoOriginal;
      titulo.setAttribute('title', textoOriginal);
    });
  }

function toggleHeart(btn, idProducto) {
  const nombreUsuario = localStorage.getItem('usuario');
  if (!nombreUsuario) {
    window.location.href = "login.html";
    return;
  }

  btn.classList.toggle('liked');
  const icon = btn.querySelector('i');
  const liked = btn.classList.contains('liked');

  icon.classList.toggle('fa-solid', liked);
  icon.classList.toggle('fa-regular', !liked);

  const payload = {
    nombre: nombreUsuario,
    id_producto: idProducto,
    liked: liked
  };

  fetch("http://localhost/TailsUp-Backend/endPointAgregarFavorito.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(res => res.json())
    .then(data => {
      if (data.status !== "success") {
        console.warn("⚠️ Error al actualizar favorito:", data.message);
      }
    })
    .catch(err => console.error("❌ Error al conectar con el servidor:", err));
}

function verificarAccionUsuario(callback) {
  const usuario = localStorage.getItem("usuario");
  if (!usuario) {
    window.location.href = "login.html";
  } else {
    callback();
  }
}

function formatearPrecio(precio) {
  const p = String(precio);
  if (!p.includes('.')) return `${p}.00`;
  const partes = p.split('.');
  return partes[1].length === 1 ? `${p}0` : p;
}
</script>



<script>
        const toggleBtn = document.querySelector('.toggleFiltrosBtn');
        const cerrarBtn = document.querySelector('.cerrarBtn');
        const filtros = document.querySelector('.containerFiltros');

        toggleBtn.addEventListener('click', () => {
            filtros.classList.add('visible');
        });
        cerrarBtn.addEventListener('click', () => {
            filtros.classList.remove('visible');
        });

        function cerrarFiltros() {
            filtros.classList.remove('visible');
        }
    </script>
 <script>
        window.addEventListener('DOMContentLoaded', () => {
            const micuenta = document.getElementById('micuenta');
            const micuentaImg = document.getElementById('micuentaImg');
            const menuUsuario = document.getElementById('menuUsuario');
            const nombreUsuario = localStorage.getItem('usuario');

            if (nombreUsuario) {
                micuenta.textContent = nombreUsuario;
                micuenta.href = '#'; // Evita redirección
                micuentaImg.href = '#'
                // Mostrar/ocultar menú al hacer clic
                // Mostrar/ocultar menú al hacer clic
                const toggleMenu = (e) => {
                    e.preventDefault();
                    menuUsuario.classList.toggle('show');
                };

                micuenta.addEventListener('click', toggleMenu);
                micuentaImg.addEventListener('click', toggleMenu);


                // Cerrar sesión
                document.getElementById('cerrarSesion').addEventListener('click', () => {
                    localStorage.removeItem('usuario');
                    window.location.href = 'login.html';
                });
            }
        });
    </script>



    
</body>
</html>