<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Tails-Up | Favoritos</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="css/nav.css">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/mensajesAlerta.css">
  <link rel="stylesheet" href="css/favoritos.css">
  <link rel="stylesheet" href="css/footer.css">  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="shortcut icon" href="images/isotipoTailsUp.png" type="image/x-icon">
</head>

<body>
  <div id="modalProducto" class="modal-producto">
    <div class="modal-contenido-wrapper">
      <span class="cerrar-modal" onclick="cerrarModalProducto()">&times;</span>

      <!-- Secci√≥n principal con imagen e info -->
      <div class="modal-contenido-grid">
        <div class="modal-img">
          <img id="modalImagenProducto" src="" alt="Imagen del producto">
          <p class="ampliarTexto">Coloca el cursor sobre la imagen para hacer zoom</p>
        </div>

        <div class="modal-info">
          <h2 id="modalNombreProducto" class="titulo"></h2>
          <p id="modalMarcaProducto" class="marca-link"></p>

          <div class="rating">
            <div id="modalEstrellas" class="estrellas-dinamicas"></div>
            <span id="modalRatingVentas"></span>
          </div>

          <div class="precioSeccion">
            <p class="precio-actual" id="modalPrecioProducto"></p>
            <p class="precio-anterior" id="modalPrecioAnteriorProducto"></p>
          </div>

          <p id="modalDescripcionProducto" class="descripcion"></p>

          <div class="cantidadCompra">
            <label for="cantidad" style="font-family: poppins;">Cantidad:</label>
            <div class="cantidadControles">
              <button type="button" onclick="cambiarCantidad(-1)">‚àí</button>
              <input type="number" id="cantidad" name="cantidad" value="1" min="1" readonly>
              <button type="button" onclick="cambiarCantidad(1)">+</button>
            </div>
          </div>

          <div class="botonesModal">
            <button class="btnCompraModal"
              onclick="verificarAccionUsuario(() => agregarAlCarritoYRedirigir(localStorage.getItem('idProductoActual'), obtenerCantidad()))">Comprar
              ahora</button>
            <button class="btnCarritoModal"
              onclick="verificarAccionUsuario(() => agregarAlCarrito(localStorage.getItem('idProductoActual'), obtenerCantidad()))">
              <img src="images/CarritoSimple.png" alt="carrito"> Agregar al carrito
            </button>
          </div>
        </div>
      </div>

      <!-- Comentarios -->
      <div class="zonaComentarios">
        <h3>Rese√±as</h3>
        <div id="comentariosLista" class="comentarios-lista">
          <!-- Comentarios cargados din√°micamente -->
        </div>

        <div class="comentarioForm">
          <label for="ratingComentario">Tu calificaci√≥n:</label>
          <div id="estrellasFormulario" class="estrellas-formulario">
            <!-- Se llenan din√°micamente -->
          </div>

          <textarea id="nuevoComentario" placeholder="Escribe tu comentario..."></textarea>
          <button onclick="agregarComentario()">Enviar</button>
        </div>
      </div>

    </div>
  </div>
  <header>
    <nav>
            <div class="medio">
                <img class="logoNav" src="images/logoCompleto.png" alt="logoNav.png">
                <div class="buscadorDiv">
                    <button id="btnBuscar"><img src="images/lupa.png" alt="lupa.png"></button>
                    <input class="buscador" type="search" placeholder="Buscar" id="inputBusqueda">
                    <div id="resultadosBusqueda" class="resultadosBusqueda"></div>
                </div>

                <div class="accesoDirecto">
                    <div class="navDiv">
                        <a class="carritoBtn" href="carrito.html"><img class="carrito" src="images/Carrito.png"
                                alt="carrito.png"></a>
                        <a class="carritoTxt" href="carrito.html">Carrito</a>
                    </div>
                    <div class="navDiv">
                        <a id="micuentaImg" class="loginBtn" href="login.html"><img class="login"
                                src="images/micuenta.png" alt="micuenta.png"></a>
                        <a id="micuenta" class="miCuentaTxt" id="micuenta" href="login.html">Mi cuenta</a>
                    </div>
                </div>

            </div>
            <div class="abajo">
                <a href="index.html">Home</a>
                <a href="shop.html">Tienda</a>
                <a href="blog.html">Consejos</a>
                <a href="acerca.html">Acerca de</a>

                <div id="menuUsuario" class="dropdown-menu">
                    <div class="cart-tab"></div>
                    <ul>
                        <li><a href="favoritos.html">Favoritos</a></li>
                        <li><a href="compras.html">Mis compras</a></li>
                        <li><a href="#" id="cerrarSesion">Cerrar sesi√≥n</a></li>
                    </ul>
                </div>
            </div>

        </nav>
  </header>
  <div class="title">
    <h1>Favoritos</h1>
  </div>
  <div class="containerPC" id="contenedorProductos">
    <!-- Aqui van los productos mas vendidos de comida-->
  </div>

  <div id="customAlertContainer" class="custom-alert-container"></div>
  <footer>
        <img class="imgPatita" src="images/patita.png" alt="patita.png">
        <div class="containerNaranja">
            <div class="divTextoRegistro">
                <p>Registrate para obtener actualizaciones y novedades.</p>
            </div>
            <div class="divIngresa">
                <input class="inputRegistra" type="text" placeholder="Ingresa tu email">
                <button class="btnSuscribirse">Registrarse</button>
            </div>
        </div>
        <div class="containerRedes">
            <div class="containerEnlaces">
                <a href="/index.html">Inicio</a>
                <a href="/shop.html">Tienda</a>
                <a href="/blog.html">Blog</a>
                <a href="/acerca.html">Acerca de</a>
            </div>
            <div class="containerImagenes">
                <a href="https://www.facebook.com/Mascotas.LaPelicula/?brand_redir=1472796759677795" target="_blank" rel="noopener"><img src="images/facebook.png" alt="facebook.png"></a>
                <a href="https://x.com/iRazasdePerros" target="_blank" rel="noopener"><img src="images/twitter.png" alt="twitter.com"></a>
                <a href="https://www.instagram.com/animalizar/?hl=es" target="_blank" rel="noopener"><img src="images/instagram.png" alt="instagram.png"></a>
                <a href="https://www.youtube.com/@MascotasyFamiliasFelices" target="_blank" rel="noopener"><img src="images/youTube.png" alt="youtube.png"></a>
            </div>
        </div>
        <hr>
        <div class="containerFinal">
            <p>Derechos reservados al ITM</p>
            <img src="images/logoFinal.png" alt="tailsUp.png">
            <p>Terminos de servicio</p>
        </div>
    </footer> 
  <script>
    function toggleHeart(btn) {
      const icon = btn.querySelector('i');
      const isLiked = btn.classList.toggle('liked');

      // Cambia √≠cono de contorno a s√≥lido
      if (isLiked) {
        icon.classList.remove('fa-regular');
        icon.classList.add('fa-solid');
      } else {
        icon.classList.remove('fa-solid');
        icon.classList.add('fa-regular');
      }

      // Reinicia animaci√≥n si ya est√° aplicada
      btn.style.animation = 'none';
      btn.offsetHeight; // Trigger reflow
      btn.style.animation = null;
    }
  </script>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const micuenta = document.getElementById('micuenta');
      const micuentaImg = document.getElementById('micuentaImg');
      const menuUsuario = document.getElementById('menuUsuario');
      const nombreUsuario = localStorage.getItem('usuario');

      if (nombreUsuario) {
        const primerNombre = nombreUsuario.trim().split(' ')[0];
        micuenta.textContent = primerNombre;
        micuenta.href = '#'; // Evita redirecci√≥n
        micuenta.style.marginTop = "-42%";
        micuentaImg.href = '#'
        const toggleMenu = (e) => {
          e.preventDefault();
          menuUsuario.classList.toggle('show');
        };

        micuenta.addEventListener('click', toggleMenu);
        micuentaImg.addEventListener('click', toggleMenu);

        document.getElementById('cerrarSesion').addEventListener('click', () => {
          localStorage.removeItem('usuario');
          window.location.href = 'login.html';
        });
      }
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const nombreUsuario = localStorage.getItem('usuario');

      function formatearPrecio(precio) {
        if (!precio.includes('.')) return `${precio}.00`;
        const partes = precio.split('.');
        return partes[1].length === 1 ? `${precio}0` : precio;
      }
      function manejarTruncadoResponsivo(selector) {
        const elementos = document.querySelectorAll(selector);

        let maxCaracteres = window.innerWidth <= 768 ? 10 : 22;

        elementos.forEach(elemento => {
          const titulo = elemento.querySelector('h4');
          if (!titulo) return;

          if (!titulo.hasAttribute('data-texto-completo')) {
            titulo.setAttribute('data-texto-completo', titulo.textContent.trim());
          }

          const textoOriginal = titulo.getAttribute('data-texto-completo');

          if (textoOriginal.length > maxCaracteres) {
            // Cortar estrictamente en el l√≠mite de caracteres y agregar los puntos suspensivos
            const textoTruncado = textoOriginal.substring(0, maxCaracteres) + '...';

            titulo.textContent = textoTruncado;
            titulo.setAttribute('title', textoOriginal);
          } else {
            titulo.textContent = textoOriginal;
          }
        });
      }
      function renderizarFavoritos(productos) {
        const contenedorFavoritos = document.getElementById('contenedorProductos');
        contenedorFavoritos.innerHTML = '';

        if (!productos || productos.length === 0) {
          contenedorFavoritos.innerHTML = `
      <div style="
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        height: 200px;
        margin: 40px auto;
        font-family: 'Poppins', sans-serif;
      ">
        <i class="fa-solid fa-heart-crack" style="font-size: 60px; color: #DE6600; margin-left:-9%"></i>
        <p style="font-size: 20px; color: #003F5A;  margin-left:-9%">
          A√∫n no tienes productos en favoritos.
        </p>
      </div>
    `;
          return;
        }

        productos.forEach(producto => {
          const card = document.createElement('div');
          card.className = 'productCard';
          card.dataset.idProducto = producto.id_producto;
          card.innerHTML = `
      <div class="productImage">
        <button class="heart-button liked" onclick="toggleHeart(this)">
          <i class="fa-solid fa-heart"></i>
        </button>
        <img src="images/${producto.imagen_producto}" alt="${producto.nombre_producto}">
      </div>
      <div class="productTitle">
        <h4>${producto.nombre_producto}</h4>
      </div>
      <div class="productRating">
        <img src="images/Star.png" alt="Estrella">
        <p>(${producto.rating}) ${producto.unidades_vendidas} Sold</p>
      </div>
      <div class="productPrice">
        <p>
          $${formatearPrecio(String(producto.precio_actual))}
          ${producto.precio_anterior && producto.precio_anterior !== producto.precio_actual
              ? `<s>$${formatearPrecio(String(producto.precio_anterior))}</s>` : ''}
        </p>
      </div>
      <div class="productBtns">
         <button class="btnCompra" onclick="verificarAccionUsuario(() => comprarAhora(${producto.id_producto}))">Comprar ahora</button>
         <button class="btnCarrito" onclick="verificarAccionUsuario(() => agregarAlCarrito(${producto.id_producto}))">
          <img src="images/CarritoSimple.png" alt="carritoSimple.png">
        </button>
      </div>
    `;
          card.addEventListener('click', function (e) {
      if (e.target.closest('button')) return;
      mostrarDetallesProducto(producto);
    });

        // Previene que los botones propaguen el evento al card
        const btns = card.querySelectorAll('button');
        btns.forEach(btn => {
          btn.addEventListener('click', e => e.stopPropagation());
        });

        contenedorFavoritos.appendChild(card);
        });

        manejarTruncadoResponsivo('.productTitle');
        iniciarAjustes();
      }

      function iniciarAjustes() {
        // Definir reglas de ajuste de fuente
        const reglas = {
          default: '13px', // tama√±o normal
          condiciones: [
            { maxCaracteres: 10, fontSize: '16px' },  // si tiene hasta 10 caracteres ‚Üí fuente grande
            { maxCaracteres: 14, fontSize: '14px' },  // si tiene hasta 14 caracteres ‚Üí fuente media
            { maxCaracteres: 18, fontSize: '12px' }   // si tiene hasta 18 caracteres ‚Üí fuente m√°s peque√±a
          ]
        };

        // Ajustar tama√±os de fuente en los elementos de la p√°gina
        ajustarTama√±oFuente('.productRating p', reglas);
        ajustarTama√±oFuente('.productPrice p', reglas);
      }
      function ajustarTama√±oFuente(selector, reglas) {
        const elementos = document.querySelectorAll(selector);

        elementos.forEach(elemento => {
          const texto = elemento.textContent.trim();
          const longitud = texto.length;

          // Definir tama√±o por defecto
          let fontSize = reglas.default;

          // Aplicar reglas de tama√±os
          for (let regla of reglas.condiciones) {
            if (longitud >= regla.minCaracteres) {
              fontSize = regla.fontSize;
            }
          }

          elemento.style.fontSize = fontSize;
        });
      }
      console.log("üßë Enviando nombre de usuario:", nombreUsuario);
      fetch('http://localhost/TailsUp-Backend/endPointGetFavoritos.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ usuario: nombreUsuario })
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && Array.isArray(data.productos)) {
            console.log(data.productos);
            renderizarFavoritos(data.productos);
          } else {
            console.warn('No se encontraron favoritos o hubo un error en la respuesta');
          }
        })
        .catch(error => {
          console.error('Error al obtener favoritos:', error);
        });
    });
  </script>
  <script>
    function verificarAccionUsuario(callback) {
  const usuario = localStorage.getItem("usuario");
  if (!usuario) {
    window.location.href = "login.html";
  } else {
    callback();
  }
}

function comprarAhora(idProducto) {
  const idUsuario = localStorage.getItem('idUsuario');
  if (!idUsuario) {
    console.warn("‚ö†Ô∏è Usuario no autenticado. Redirigiendo a la p√°gina de inicio de sesi√≥n.");
    window.location.href = "login.html";
    return;
  }

  const payload = {
    idUsuario: idUsuario,
    idProducto: idProducto,
    cantidad: 1 // Default quantity, can be adjusted as needed
  };

  fetch("http://localhost/TailsUp-Backend/endPointAddToCart.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        setTimeout(() => {
          window.location.href = "carrito.html";
        }, 10);
      } else {
        console.warn("‚ö†Ô∏è Error al a√±adir al carrito:", data.error);
      }
    })
    .catch(err => console.error("‚ùå Error al conectar con el servidor:", err));
}

function agregarAlCarrito(idProducto) {
  const idUsuario = localStorage.getItem('idUsuario');
  if (!idUsuario) {
    console.warn("‚ö†Ô∏è Usuario no autenticado. Redirigiendo a la p√°gina de inicio de sesi√≥n.");
    window.location.href = "login.html";
    return;
  }

  const payload = {
    idUsuario: idUsuario,
    idProducto: idProducto,
    cantidad: 1 // Default quantity, can be adjusted as needed
  };

  fetch("http://localhost/TailsUp-Backend/endPointAddToCart.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showCustomAlert("‚úÖ Producto a√±adido al carrito correctamente.", '#41BB74');
      } else {
        console.warn("‚ö†Ô∏è Error al a√±adir al carrito:", data.error);
      }
    })
    .catch(err => console.error("‚ùå Error al conectar con el servidor:", err));
}
    function obtenerCantidad() {
      const cantidadInput = document.getElementById('cantidad');
      return cantidadInput ? parseInt(cantidadInput.value, 10) : 1;
    }

    function agregarAlCarrito(idProducto, cantidad) {
      const idUsuario = localStorage.getItem('idUsuario');

      console.log("ID Usuario:", idUsuario);
      console.log("ID Producto:", idProducto);
      console.log("Cantidad:", cantidad);

      if (!idUsuario) {
        console.warn("‚ö†Ô∏è Usuario no autenticado. Redirigiendo a la p√°gina de inicio de sesi√≥n.");
        window.location.href = "login.html";
        return;
      }

      const payload = {
        idUsuario: idUsuario,
        idProducto: idProducto,
        cantidad: cantidad
      };

      fetch("http://localhost/TailsUp-Backend/endPointAddToCart.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showCustomAlert("‚úÖ Producto a√±adido al carrito correctamente.", "#41BB74");
          } else {
            console.warn("‚ö†Ô∏è Error al a√±adir al carrito:", data.error);
          }
        })
        .catch(err => console.error("‚ùå Error al conectar con el servidor:", err));
    }

    function agregarAlCarritoYRedirigir(idProducto, cantidad) {
      agregarAlCarrito(idProducto, cantidad);
      window.location.href = "carrito.html";
    }
  </script>
  <script>
    function toggleHeart(btn) {
      const icon = btn.querySelector('i');
      const isLiked = btn.classList.toggle('liked');

      // Cambiar √≠cono
      icon.classList.toggle('fa-solid', isLiked);
      icon.classList.toggle('fa-regular', !isLiked);

      // Reiniciar animaci√≥n
      btn.style.animation = 'none';
      btn.offsetHeight;
      btn.style.animation = null;

      // Obtener nombre de usuario
      const nombreUsuario = localStorage.getItem('usuario');
      if (!nombreUsuario) {
        showCustomAlert('Debes iniciar sesi√≥n para usar esta funci√≥n.', '#E52727');
        return;
      }

      // Obtener id del producto desde el DOM
      const card = btn.closest('.productCard');
      const idProducto = card.dataset.idProducto;


      const payload = {
        nombre: nombreUsuario,
        id_producto: idProducto,
        liked: isLiked
      };

      fetch('http://localhost/TailsUp-Backend/endPointAgregarFavorito.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
        .then(response => response.json())
        .then(data => {
        })
        .catch(error => {
          console.error('Error al agregar/eliminar favorito:', error);
        });
    }
  </script>
  <script src="js/customAlerts.js"></script>
  <script>
    function obtenerCantidad() {
      const cantidadInput = document.getElementById('cantidad');
      return cantidadInput ? parseInt(cantidadInput.value, 10) : 1;
    }

    function agregarAlCarrito(idProducto, cantidad) {
      const idUsuario = localStorage.getItem('idUsuario');

      console.log("ID Usuario:", idUsuario);
      console.log("ID Producto:", idProducto);
      console.log("Cantidad:", cantidad);

      if (!idUsuario) {
        console.warn("‚ö†Ô∏è Usuario no autenticado. Redirigiendo a la p√°gina de inicio de sesi√≥n.");
        window.location.href = "login.html";
        return;
      }

      const payload = {
        idUsuario: idUsuario,
        idProducto: idProducto,
        cantidad: cantidad
      };

      fetch("http://localhost/TailsUp-Backend/endPointAddToCart.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showCustomAlert("‚úÖ Producto a√±adido al carrito correctamente.", "#41BB74");
          } else {
            console.warn("‚ö†Ô∏è Error al a√±adir al carrito:", data.error);
          }
        })
        .catch(err => console.error("‚ùå Error al conectar con el servidor:", err));
    }

    function agregarAlCarritoYRedirigir(idProducto, cantidad) {
      agregarAlCarrito(idProducto, cantidad);
      window.location.href = "carrito.html";
    }
  </script>
  <script src="js/buscarAndFullCard.js"></script>




</body>

</html>